"use strict";function playAudioClip(a){new Audio(a).play()}function sendMessageToActiveTab(a){chrome.tabs.query({active:!0,currentWindow:!0},function(b){b[0]&&chrome.tabs.sendMessage(b[0].id,a)})}function handleInfoAdded(){chrome.storage.local.get("options",function(a){var b=a.options;if(b&&b.enableAudio&&playAudioClip("sounds/camera-shutter-click-08.mp3"),b){var c;switch(b.onCreateClip){case"openCopycat":c="toggleView";break;case"jiggle":c="jiggleToggle"}c&&sendMessageToActiveTab({message:c,eventName:"onCreateClip"})}})}function getClipType(a){return"clipSelection"===a.menuItemId?"Text":"clipImage"===a.menuItemId?"Image":"Unknown"}function addInfoToStorage(a){chrome.storage.local.get("clips",function(b){b.clips.push(a),chrome.storage.local.set(b,function(){chrome.runtime.lastError?chrome.runtime.sendMessage({analytic:{type:"event",payload:{category:"Error",action:"chrome.runtime.lastError",label:"Error adding info to storage: "+chrome.runtime.lastError.message}}}):(handleInfoAdded(),chrome.tabs.query({active:!0},function(b){var c={category:"Clipped",action:getClipType(a)};b&&b.length>0&&(c.label=b[0].title),chrome.runtime.sendMessage({analytic:{type:"event",payload:c}})}))})})}function onContextMenuClickHandler(a){"clipSelection"===a.menuItemId||"clipImage"===a.menuItemId?(a.created=(new Date).toString(),addInfoToStorage(a)):chrome.runtime.sendMessage({analytic:{type:"event",payload:{category:"Error",action:"Menu",label:"Unknown menu item clicked: "+a.menuItemId}}})}function enableBrowserActionIcon(a){var b=a?"images/icon-19.png":"images/icon-19-inactive.png",c=a?"images/icon-38.png":"images/icon-38-inactive.png",d=a?"Click to disable Copycat":"Click to enable Copycat";chrome.browserAction.setIcon({path:{19:b,38:c}}),chrome.browserAction.setTitle({title:d})}function forEachTab(a){chrome.tabs.query({},function(b){b.forEach(function(b){"function"==typeof a&&a(b)})})}function sendEnabledMessageToAllTabs(a){forEachTab(function(b){chrome.tabs.sendMessage(b.id,{message:"toggleEnabled",enabled:!!a})})}function toggleEnabled(){chrome.storage.local.get("options",function(a){var b=a.options||{};b.enabled=!b.enabled,chrome.storage.local.set({options:b},function(){chrome.runtime.lastError||(enableBrowserActionIcon(b.enabled),sendEnabledMessageToAllTabs(b.enabled))})})}function onBrowserActionClickHandler(){toggleEnabled()}function injectScriptToTab(a,b){chrome.tabs.executeScript(a,{file:b},function(){var a=chrome.runtime.lastError;a&&a.message&&chrome.runtime.sendMessage({analytic:{type:"event",payload:{category:"Error",action:"chrome.runtime.lastError",label:"Error executing script: "+a.message}}})})}function injectStylesheetToTab(a,b){chrome.tabs.insertCSS(a,{file:b},function(){var a=chrome.runtime.lastError;a&&a.message&&chrome.runtime.sendMessage({analytic:{type:"event",payload:{category:"Error",action:"chrome.runtime.lastError",label:"Error inserting CSS: "+a.message}}})})}function injectStylesheetsToTab(a,b){b.forEach(function(b){injectStylesheetToTab(a,b)})}function injectScriptsToTab(a,b){b.forEach(function(b){injectScriptToTab(a,b)})}function injectContentScriptToAllTabs(a){forEachTab(function(b){-1===b.url.indexOf("chrome://")&&-1===b.url.indexOf("https://chrome.google.com/webstore")&&(injectStylesheetsToTab(b.id,a.css),injectScriptsToTab(b.id,a.js))})}function injectContentScriptsToAllTabs(){var a=chrome.runtime.getManifest(),b=a.content_scripts;b.forEach(function(a){injectContentScriptToAllTabs(a)}),setTimeout(function(){sendMessageToActiveTab({message:"toggleView"})},2e3)}function installContextMenus(){chrome.contextMenus.create({title:"Copycat this Selection",contexts:["selection"],id:"clipSelection"}),chrome.contextMenus.create({title:"Copycat this Image",contexts:["image"],id:"clipImage"})}function installClipsStorage(){chrome.storage.local.get("clips",function(a){a.clips||chrome.storage.local.set({clips:[]},function(){chrome.runtime.lastError&&chrome.runtime.sendMessage({analytic:{type:"event",payload:{category:"Error",action:"chrome.runtime.lastError",label:"Unable to initialize clips collection: "+chrome.runtime.lastError.message}}})})})}function installArchiveStorage(){chrome.storage.local.get("archive",function(a){a.archive||chrome.storage.local.set({archive:[]},function(){chrome.runtime.lastError&&chrome.runtime.sendMessage({analytic:{type:"event",payload:{category:"Error",action:"chrome.runtime.lastError",label:"Unable to initialize archive collection: "+chrome.runtime.lastError.message}}})})})}function sendInstalledGAEvent(){ga("send",{hitType:"event",eventCategory:"Copycat",eventAction:"Installed"})}function installOptionsStorage(){chrome.storage.local.get("options",function(a){a.options=a.options||{};for(var b in DEFAULT_OPTIONS)a.options.hasOwnProperty(b)||(a.options[b]=DEFAULT_OPTIONS[b]);chrome.storage.local.set(a,function(){chrome.runtime.lastError&&chrome.runtime.sendMessage({analytic:{type:"event",payload:{category:"Error",action:"chrome.runtime.lastError",label:"Unable to initialize options: "+chrome.runtime.lastError.message}}})})})}function installGoogleAnalytics(){!function(a,b,c,d,e,f,g){a.GoogleAnalyticsObject=e,a[e]=a[e]||function(){(a[e].q=a[e].q||[]).push(arguments)},a[e].l=1*new Date,f=b.createElement(c),g=b.getElementsByTagName(c)[0],f.async=1,f.src=d,g.parentNode.insertBefore(f,g)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-39868263-47","auto"),ga("set","checkProtocolTask",null)}var DEFAULT_OPTIONS={enabled:!0,enableAudio:!0,allowGA:!0,onCreateClip:"none",closeOnCopy:!1};chrome.runtime.onInstalled.addListener(function(){installContextMenus(),installClipsStorage(),installArchiveStorage(),installOptionsStorage(),injectContentScriptsToAllTabs(),sendInstalledGAEvent()}),chrome.contextMenus.onClicked.addListener(onContextMenuClickHandler),chrome.browserAction.onClicked.addListener(onBrowserActionClickHandler),chrome.runtime.onMessage.addListener(function(a){a.message&&chrome.tabs.query({active:!0,currentWindow:!0},function(b){chrome.tabs.sendMessage(b[0].id,a)}),a.openNewTab&&chrome.tabs.create({url:a.openNewTab}),a.analytic&&chrome.storage.local.get("options",function(b){var c=b.options;if(c&&c.allowGA){var d=a.analytic;"pageview"===d.type?ga("send","pageview",d.payload):"event"===d.type&&ga("send",{hitType:"event",eventCategory:d.payload.category,eventAction:d.payload.action,eventLabel:d.payload.label})}})}),chrome.commands.onCommand.addListener(function(a){"toggle-copycat"===a&&sendMessageToActiveTab({message:"toggleView",eventName:"onCommand"})}),installGoogleAnalytics();